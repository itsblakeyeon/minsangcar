<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMS 발송 - Faraday SMS</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-indigo-600 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between items-center h-16">
        <h1 class="text-xl font-bold">Faraday SMS</h1>
        <div class="flex space-x-4">
          <a href="customers.html" class="px-3 py-2 rounded hover:bg-indigo-500">고객 목록</a>
          <a href="conversations.html" class="px-3 py-2 rounded hover:bg-indigo-500">대화 내역</a>
          <a href="send.html" class="px-3 py-2 rounded bg-indigo-700">SMS 발송</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid grid-cols-2 gap-6">
      <!-- Single Send -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6">개별 발송</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">수신자 선택</label>
            <select id="recipientSelect" class="w-full border rounded px-3 py-2">
              <option value="">-- 고객 선택 --</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">또는 직접 입력</label>
            <input type="text" id="phoneInput" placeholder="010-0000-0000"
              class="w-full border rounded px-3 py-2">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">메시지</label>
            <textarea id="messageInput" rows="4" placeholder="메시지를 입력하세요..."
              class="w-full border rounded px-3 py-2"></textarea>
            <p class="text-xs text-gray-400 mt-1"><span id="charCount">0</span>/90자 (SMS)</p>
          </div>

          <button onclick="sendSingle()"
            class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700">
            발송하기
          </button>
        </div>
      </div>

      <!-- Bulk Send -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6">상태별 일괄 발송</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">대상 상태</label>
            <select id="statusSelect" class="w-full border rounded px-3 py-2">
              <option value="">-- 상태 선택 --</option>
              <option value="new">신규 (new)</option>
              <option value="active">활성 (active)</option>
              <option value="contacted">연락됨 (contacted)</option>
              <option value="interested">관심 (interested)</option>
              <option value="converted">전환 (converted)</option>
              <option value="inactive">비활성 (inactive)</option>
            </select>
            <p id="statusCount" class="text-sm text-gray-500 mt-1"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">메시지</label>
            <textarea id="bulkMessageInput" rows="4" placeholder="메시지를 입력하세요..."
              class="w-full border rounded px-3 py-2"></textarea>
            <p class="text-xs text-gray-400 mt-1"><span id="bulkCharCount">0</span>/90자 (SMS)</p>
          </div>

          <button onclick="sendBulk()"
            class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">
            일괄 발송하기
          </button>
        </div>
      </div>
    </div>

    <!-- Recent Logs -->
    <div class="bg-white rounded-lg shadow p-6 mt-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">최근 발송 내역</h2>
      <div id="sendLogs" class="space-y-2">
        <p class="text-gray-400 text-center py-4">발송 내역이 없습니다.</p>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = '/api';
    let customers = [];
    let sendLogs = [];

    async function loadCustomers() {
      try {
        const res = await fetch(`${API_BASE}/customers`);
        customers = await res.json();

        const select = document.getElementById('recipientSelect');
        select.innerHTML = '<option value="">-- 고객 선택 --</option>' +
          customers.map(c => `<option value="${c.phone}" data-name="${c.name}">${c.name} (${c.phone})</option>`).join('');

        // Check URL params
        const params = new URLSearchParams(window.location.search);
        const phone = params.get('phone');
        const name = params.get('name');
        if (phone) {
          document.getElementById('phoneInput').value = phone;
          select.value = phone;
        }
      } catch (err) {
        console.error('Error:', err);
      }
    }

    function updateStatusCount() {
      const status = document.getElementById('statusSelect').value;
      if (!status) {
        document.getElementById('statusCount').textContent = '';
        return;
      }
      const count = customers.filter(c => c.status === status).length;
      document.getElementById('statusCount').textContent = `${count}명의 고객에게 발송됩니다.`;
    }

    async function sendSingle() {
      const select = document.getElementById('recipientSelect');
      const phone = document.getElementById('phoneInput').value || select.value;
      const message = document.getElementById('messageInput').value;

      if (!phone || !message) {
        alert('수신번호와 메시지를 입력해주세요.');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/sms/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to: phone, message })
        });

        const result = await res.json();
        addLog(result);

        if (result.success) {
          alert('발송 성공!');
          document.getElementById('messageInput').value = '';
        } else {
          alert('발송 실패: ' + JSON.stringify(result.error));
        }
      } catch (err) {
        console.error('Error:', err);
        alert('발송 실패');
      }
    }

    async function sendBulk() {
      const status = document.getElementById('statusSelect').value;
      const message = document.getElementById('bulkMessageInput').value;

      if (!status || !message) {
        alert('상태와 메시지를 입력해주세요.');
        return;
      }

      const count = customers.filter(c => c.status === status).length;
      if (!confirm(`${count}명에게 문자를 발송하시겠습니까?`)) return;

      try {
        const res = await fetch(`${API_BASE}/customers/send-by-status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status, message })
        });

        const result = await res.json();

        if (result.summary) {
          alert(`발송 완료!\n성공: ${result.summary.success}건\n실패: ${result.summary.failed}건`);
          document.getElementById('bulkMessageInput').value = '';

          result.results.success.forEach(r => addLog({ success: true, to: r.phone, message }));
          result.results.failed.forEach(r => addLog({ success: false, to: r.phone, message, error: r.reason }));
        }
      } catch (err) {
        console.error('Error:', err);
        alert('발송 실패');
      }
    }

    function addLog(result) {
      sendLogs.unshift({
        ...result,
        timestamp: new Date().toLocaleString('ko-KR')
      });
      renderLogs();
    }

    function renderLogs() {
      if (sendLogs.length === 0) {
        document.getElementById('sendLogs').innerHTML = '<p class="text-gray-400 text-center py-4">발송 내역이 없습니다.</p>';
        return;
      }

      document.getElementById('sendLogs').innerHTML = sendLogs.slice(0, 10).map(log => `
        <div class="flex items-center justify-between p-3 rounded ${log.success ? 'bg-green-50' : 'bg-red-50'}">
          <div>
            <span class="font-medium ${log.success ? 'text-green-700' : 'text-red-700'}">
              ${log.success ? '성공' : '실패'}
            </span>
            <span class="text-gray-600 ml-2">${log.to}</span>
            <p class="text-sm text-gray-500 truncate max-w-md">${log.message}</p>
          </div>
          <span class="text-xs text-gray-400">${log.timestamp}</span>
        </div>
      `).join('');
    }

    // Character count
    document.getElementById('messageInput').addEventListener('input', (e) => {
      document.getElementById('charCount').textContent = e.target.value.length;
    });
    document.getElementById('bulkMessageInput').addEventListener('input', (e) => {
      document.getElementById('bulkCharCount').textContent = e.target.value.length;
    });

    // Recipient select
    document.getElementById('recipientSelect').addEventListener('change', (e) => {
      if (e.target.value) {
        document.getElementById('phoneInput').value = e.target.value;
      }
    });

    document.getElementById('statusSelect').addEventListener('change', updateStatusCount);

    loadCustomers();
  </script>
</body>
</html>
